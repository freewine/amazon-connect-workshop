---
title: "使用 Privatelink 对外暴露应用"
chapter: false
weight: 71
tags:
  - advanced
---

## AWS Privatelink 介绍
AWS PrivateLink 让您能够将自己的 VPC 安全地连接到支持的 AWS 服务，其中包括您在 AWS 上的服务、其他 AWS 账户托管的服务以及 AWS Marketplace 上的第三方服务。您的 VPC 与任何此类服务之间的流量不会传出 Amazon 网络，因此您不在需要通过 Internet 网关、NAT 设备、公有 IP 地址或 VPN 连接来与服务进行通信。

您可以在 VPC 中创建自己的应用程序并将其配置为 AWS PrivateLink 支持的服务（也称作终端节点服务）。其他 AWS 委托人可以使用接口 VPC 终端节点，在他们的 VPC 和您的终端节点服务之间创建连接。您是服务提供商，而创建与您的服务之间的连接的 AWS 委托人是服务用户。

![](/images/7.ApplicationSecurity/Privatelink-1.png)

以下是创建 Privatelink 的步骤：

1. （服务提供者）在您的 VPC 中为应用程序创建一个 Network Load Balancer，负载均衡器接收来自服务使用者的请求并将请求路由到您的服务。建议您在区域内的所有可用区中配置您的服务。
2. （服务提供者）创建 VPC 终端节点服务配置并指定 Network Load Balancer。
3. （服务提供者）向特定服务用户（AWS 账户、IAM 用户和 IAM 角色）授予权限，允许他们创建与您的终端节点服务之间的连接。
4. （服务使用者）已被授予权限的服务使用者可创建与您的服务连接的接口终端节点。
5. （服务提供者）要激活连接，需要接受接口终端节点连接请求。默认情况下，必须手动接受连接请求，但可以配置为自动接受。

本实验中，将使用前面章节中创建的 WordPress 作为对外提供服务的应用，通过 Privatelink 对外暴露。另外创建一个新的 VPC，用来模拟外部账户，通过 VPC 终端节点访问 Wordpress 应用。

## 1. 创建 Privatelink 对应的 Network Load Balancer

在 EC2 Console --> 负载均衡器，创建  Network Load Balancer: 
 - 名称： ```Privatelink```
 - 模式： 内部
 - 侦听器： 协议-TCP，端口-80
 - VPC： 选择 SecworkshopVPC
 - 可用区：选择 PrivateAppSubnet1 和 PrivateAppSubnet2

![](/images/7.ApplicationSecurity/Privatelink-2.png)

新建目标组：
 - 名称：```Privatelink-TG```
 - 目标类型： 实例
 - 协议类型： TCP
 - 端口：  80

![](/images/7.ApplicationSecurity/Privatelink-3.png)

注册目标：
 - 已注册目标： 将 WordpressSever1 和 WordpressServer2 添加到目标
 - 端口： 80

![](/images/7.ApplicationSecurity/Privatelink-4.png)

## 2. 创建 Privatelink 对应的 VPC 终端节点服务 
进入 VPC Console --> 终端节点服务 --> 创建终端节点服务，选择刚刚创建 Privatelink 作为关联的网络负载均衡器，其他保持默认配置。
![](/images/7.ApplicationSecurity/Privatelink-5.png)
创建完成后，记录 VPC 终端节点服务的名称：com.amazonaws.vpce.ap-northeast-1.vpce-svc-0e110b262c131d646
{{% notice note %}}
注意：如果 Privatelink 是需要对其他 AWS 账户暴露应用，还需要将服务访问者的账户添加到 “白名单委托人” 列表中。
在本实验中，是用另外一个 VPC 来模拟服务访问者，所以不需要配置白名单。
{{% /notice  %}}
![](/images/7.ApplicationSecurity/Privatelink-6.png)

## 3. 配置 Privatelink 的服务使用者
首先点击以下**Launch Template**链接，利用 CloudFormation 再创建一个 VPC 和一台 EC2，用来模拟 Privatelink 的服务使用者。

[Launch Template](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?stackName=Privatelink-ConsumerVPC&templateURL=https://hxh-public.s3-ap-northeast-1.amazonaws.com/Privatelink-VPC.yaml)

{{% notice note %}}
Privatelink 的服务提供者和服务使用者的 VPC CIDR 可以相同，Privatelink 的访问不需要配置路由，所以不存在路由冲突问题。
{{% /notice  %}}

Cloudformation 运行完成后，进入 VPC 控制台 --> 终端节点 --> 创建终端节点：
 - 服务类别： 按名称查找服务
 - 服务名称： 输入前面步骤中创建的终端节点服务，然后点击验证
 - VPC： 选择```Privatelink-ConsumerVPC```
 - 子网：保持默认选择
 - 安全组： 选择```PrivatelinkSG```安全组

![](/images/7.ApplicationSecurity/Privatelink-10.png)

创建完成后，终端节点的状态为```待接受```， 并记录 Privatelink-ConsumerVPC 中终端节点的 DNS 名称，在 ConsumerVPC 中将使用该 DNS 名称，访问服务提供者中的 Wordpress 应用。
```vpce-0dd2350f52dcf65c8-4rh8kwm7.vpce-svc-0e110b262c131d646.ap-northeast-1.vpce.amazonaws.com```

然后到 VPC 控制台 --> 终端节点服务 --> 选择之前创建的终端节点服务 --> 终端节点连接，会看到有一个```待接受```的连接请求，选择```接受终端连接请求```。

等待终端节点连接状态从```待处理```变为```可用```.

![](/images/7.ApplicationSecurity/Privatelink-7.png)


## 4. 验证 Privatelink 访问

首先进入 EC2 控制台 --> Privatelink-ConsumerInstance --> 操作 --> 安全 --> 获取 Windows 密码，使用 Key 文件获取 Windows 登录密码。
![](/images/7.ApplicationSecurity/Privatelink-8.png)

然后使用 Windows 远程桌面客户端，远程连接到 ConsumerInstance，打开浏览器，访问终端节点 DNS 名称的 URL。
```vpce-0dd2350f52dcf65c8-4rh8kwm7.vpce-svc-0e110b262c131d646.ap-northeast-1.vpce.amazonaws.com/wp-login.php```

![](/images/7.ApplicationSecurity/Privatelink-9.png)

至此已完成 Privatelink 的部署，服务提供者 SecworkshopVPC 中的 Wordpress 应用，通过终端节点服务对外暴露，从服务使用者 Privatelink-ConsumerVPC 中建立到该终端节点服务的 Privatelink 连接，然后服务使用者 VPC 中的 EC2 实例，可通过 Privatelink 提供的私有 DNS 域名，对 Wordpress 应用进行访问。
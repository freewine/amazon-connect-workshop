---
title: "使用 Inspector 进行漏洞扫描"
chapter: false
weight: 52
tags:
  - advanced
---

### 使用 Inspector 进行漏洞扫描

Amazon Inspector 是一项自动漏洞扫描和安全评估服务，有助于提高在 AWS 上部署的应用程序的安全性与合规性。Amazon Inspector 会自动评估 EC2 上操作系统和应用程序的风险、漏洞或者安全配置规范。执行评估后，Amazon Inspector 会生成按严重程度确定优先级的安全检测详细列表。
Amazon Inspector 是一项 API 驱动型服务，能轻松集成到现有的 DevOps 流程中，实现漏洞评估的自动化，并让您的开发和运营团队能够将安全评估作为部署流程的组成部分。
Amazon Inspector 提供一个软件代理，安装在您要评估的 EC2 instances 的操作系统中。该代理将监控 EC2 instances 的行为（包括网络、文件系统和进程活动），还收集各种行为和配置数据。
{{% notice note %}}
目前，Amazon Inspector 只支持 EC2 实例。
{{% /notice  %}}

**Amazon Inspector 代理支持的基于 Linux 的操作系统**

 - 64 位 x86 实例
   - Amazon Linux 2
   - Amazon Linux 
   - Ubuntu(20.4 LTS、18.04 LTS、16.04 LTS、14.04 LTS)
   - Debian(10.x、9.0-9.5、8.0-8.7)
   - Red Hat Enterprise Linux(8.x、7.2 - 7.x、6.2 - 6.9)
   - CentOS(7.2 - 7.x、6.2 - 6.9)

 - ARM 实例
   - Amazon Linux 2
   - Red Hat Enterprise Linux (7.6 - 7.x)
   - Ubuntu (18.04 LTS、16.04 LTS)

**Amazon Inspector 代理支持的基于 Windows 的操作系统**
 - Windows Server 2019 Base
 - Windows Server 2016 Base
 - Windows Server 2012 R2
 - Windows Server 2012
 - Windows Server 2008 R2

**Amazon Inspector 规则包**
 - 网络可达性： 网络可到达性包中的规则分析您的网络配置以查找您的 EC2 instances 的安全漏洞。Amazon Inspector 生成的结果还提供有关限制不安全访问的指导。（此规则包不需要 Inspector Agent）
 - 常见漏洞和风险（CVE）： CVE 系统提供了针对公共已知的信息安全漏洞和曝光的参考方法，此包中的规则将帮助验证您的评估目标中的 EC2 instances 是否存在 CVE 中的漏洞。
 - Center for Internet Security (CIS) 基准： CIS 安全基准计划提供了定义明确、公正、基于一致性的行业最佳实践来帮助组织评估和增强其安全性。
 - Amazon Inspector 的安全最佳实践： 帮助确定您的系统的配置是否安全

下面将介绍如何使用 Amazon Inspector 对 EC2 实例进行漏洞扫描和安全评估，并获取评估结果。

### 1. 定义扫描目标
使用 Inspector 对之前部署的两台 Wordpress Server 进行漏洞扫描。 
{{% notice note %}}
Inspector Agent 将会通过 System Manager Agent 自动安装到 EC2上，所以两台 Wordpress Server 的 EC2 需要先关联 System Manager SSM Role，创建评估目标后，将通过 SSM Agent 自动安装 Inspector Agent。
{{% /notice  %}}
**进入 Amazon Inspector 控制台 --> 评估目标 --> 创建评估目标，Inspector 可以选择所有 EC2，或使用 Tag 来选择需要扫描的 EC2 实例**
 - 名称: secworkshop
 - Instance： Use Tags, 选择 secworkshop CloudFormation 部署的两台 Wordpress server

![](/images/5.SecOps/Inspector-1.png)

点击 ‘预览’，可以查看当前选择的 Tag 匹配的所有 EC2 实例，然后点击‘保存’，将自动在所有评估目标上安装 Inspector Agent 。
![](/images/5.SecOps/Inspector-2.png)

评估目标创建完成后，点击‘预览目标’，可以查看评估目标中所有实例上 Inspector Agent 的安装状态，'HEALTHY' 代表 Inspector Agent 正常。 
![](/images/5.SecOps/Inspector-3.png)

### 2. 创建扫描模版
#### 创建 SNS Topic
首先创建一个 SNS Topic，用于接收 Inspector 扫描结果的通知。 

打开 Cloud9 IDE，运行以下命令，创建一个名称为 Inspector 的 SNS Topic: 
```
aws sns create-topic --name Inspector 
``` 

记录上条命令返回的 Topic ARN，为该Topic配置Resource Policy，授予 Inspector 对此 topic 的访问权限: (东京区域的 Inspector 账户为 406045910587 )
{{% notice note %}}
不同 Region 中的 Inspector 账号不相同，具体请参考文档：[为 Amazon Inspector 通知设置 SNS 主题](https://docs.aws.amazon.com/zh_cn/inspector/latest/userguide/inspector_assessments.html#sns-topic)
{{% /notice  %}}
```
aws sns add-permission \
--topic-arn arn:aws:sns:ap-northeast-1:699962710372:Inspector \
--label Publish-Permission \
--aws-account-id 406045910587 \
--action-name  Publish Subscribe Receive
```

使用您的 Email 订阅该 SNS Topic，```其中topic arn为上一条命令的response，并请将 Email 替换为您的邮箱地址```：
```
aws sns subscribe \
--topic-arn arn:aws:sns:ap-northeast-1:699962710372:Inspector \
--protocol email --notification-endpoint hxh@amazon.com
```

然后到您的邮箱中，查收邮件```AWS Notification - Subscription Confirmation```，并点击邮件中的```Confirm subscription```。

#### 创建 Inspector 扫描模版
进入 Amazon Inspector 控制台 --> 评估模版 --> 创建评估模版 ：
 - 名称： ```secworkshop```
 - 目标名称： 选择刚刚创建的评估目标 secworkshop
 - 规则包： 可选择1个或多个规则包，建议全选4个规则包
 - 持续时间： 1小时（推荐），可选15分钟
 - SNS主题： 选择刚刚创建的名称为'Inspector‘的SNS Topic，保留全部事件
 - Assessment Schedule： 取消勾选，默认每7天自动运行一次，创建模版后会自动开始第一次漏洞扫描

点击‘创建并运行’，开始对 EC2 运行漏洞扫描。

![](/images/5.SecOps/Inspector-4.png)


#### 查看漏洞扫描结果
在 Amazon Inspector 控制台 --> 评估运行，可以查看历史已完成的，以及正在运行的漏洞扫描任务，并可查看当前扫描任务的状态，发现安全漏洞的数量，以及在任务完成后，漏洞扫描的详细报告。
![](/images/5.SecOps/Inspector-5.png)


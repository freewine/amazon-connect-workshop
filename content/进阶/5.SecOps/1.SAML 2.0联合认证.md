---
title: "SAML 2.0 联合认证"
chapter: false
weight: 51
tags:
  - advanced
---

AWS 使用 SAML 2.0（安全断言标记语言 2.0）支持联合身份验证，SAML 2.0 是许多身份验证提供商 (IdP) 使用的一种开放标准。此功能可实现联合单一登录 (SSO)，因此用户可以登录 AWS 管理控制台或调用 AWS API 操作，而不必为组织中的每个人都创建一个 IAM 用户。
比如您的企业里已经部署了AD域控服务器，并基于域控对企业人员身份进行管理，则可以把AWS的控制台登录或者API操作与现有的AD域控相结合。由于可以使用 IdP 的服务而不必编写自定义身份代理代码，因此您可以通过使用 SAML 来简化为 AWS 配置联合身份验证的过程。 

### 配置ADFS
1. 进入AWS EC2控制台，找到Windows服务器的公网IP地址，该服务器会作为AD域控： https://ap-northeast-1.console.aws.amazon.com/ec2/v2/home?region=ap-northeast-1#Instances:search=WordpressADFS;sort=instanceId
2. 登录到该Windows服务器。
- 在导航窗格中，选择 Instances (实例)。选择该实例，然后选择 Connect (连接)。
- 在 Connect to instance (连接到实例) 页面中，选择 RDP client (RDP 客户端)，然后选择 Get password (获取密码)。
- 选择 Browse (浏览) 并导航至您启动实例时所创建的私有密钥文件。选择文件并选择 Open (打开)，以将文件的全部内容复制到此页上。
- 选择 Decrypt Password。控制台将在 Password (密码) 中显示实例的默认管理员密码 ，取代之前显示的 Get password (获取密码) 链接。将密码保存在安全的位置。需要使用此密码连接实例。
然后使用Remote Desktop登录到该windows服务器。
3. 安装IIS
![](/images/5.SecOps/IIS-install1.png)
![](/images/5.SecOps/IIS-install2.png)
![](/images/5.SecOps/IIS-install3.png)
![](/images/5.SecOps/IIS-install4.png)
![](/images/5.SecOps/IIS-install5.png)
![](/images/5.SecOps/IIS-install6.png)
![](/images/5.SecOps/IIS-install7.png)
![](/images/5.SecOps/IIS-install8.png)
![](/images/5.SecOps/IIS-install9.png)
![](/images/5.SecOps/IIS-install10.png)
![](/images/5.SecOps/IIS-install11.png)
4. 安装AD
点击“Add roles and features”
![](/images/5.SecOps/AD-install1.png)
![](/images/5.SecOps/AD-install2.png)
![](/images/5.SecOps/AD-install3.png)
![](/images/5.SecOps/AD-install4.png)
![](/images/5.SecOps/AD-install5.png)
![](/images/5.SecOps/AD-install6.png)
![](/images/5.SecOps/AD-install7.png)
![](/images/5.SecOps/AD-install8.png)
![](/images/5.SecOps/AD-install9.png)
5. 将当前主机升级为域控
![](/images/5.SecOps/AD-domain1.png)
![](/images/5.SecOps/AD-domain2.png)
![](/images/5.SecOps/AD-domain3.png)
密码输入：```Passw0rd!```
![](/images/5.SecOps/AD-domain4.png)
![](/images/5.SecOps/AD-domain5.png)
![](/images/5.SecOps/AD-domain6.png)
![](/images/5.SecOps/AD-domain7.png)
![](/images/5.SecOps/AD-domain8.png)
![](/images/5.SecOps/AD-domain9.png)
升级为域控以后，会重启当前主机。等到重启完毕以后，再次登录。
6. 进入IIS管理器，如下图所示，创建证书：secworkshop
![](/images/5.SecOps/IIS-Cert0.png)
![](/images/5.SecOps/IIS-Cert1.png)
![](/images/5.SecOps/IIS-Cert2.png)
![](/images/5.SecOps/IIS-Cert3.png)
![](/images/5.SecOps/IIS-Cert4.png)

启用browser：
![](/images/5.SecOps/IIS-browser1.png)
![](/images/5.SecOps/IIS-browser2.png)
7. 创建域用户：ADFSSVC，密码为```Passw0rd!```。
![](/images/5.SecOps/AD-user1.png)
![](/images/5.SecOps/AD-user2.png)
![](/images/5.SecOps/AD-user3.png)
![](/images/5.SecOps/AD-user4.png)
![](/images/5.SecOps/AD-user5.png)

将该用户加入Domain Admins组
![](/images/5.SecOps/AD-user6.png)
![](/images/5.SecOps/AD-user7.png)
8. 安装ADFS
![](/images/5.SecOps/ADFS-install1.png)
![](/images/5.SecOps/ADFS-install2.png)
![](/images/5.SecOps/ADFS-install3.png)
![](/images/5.SecOps/ADFS-install4.png)
![](/images/5.SecOps/ADFS-install5.png)
![](/images/5.SecOps/ADFS-install6.png)
![](/images/5.SecOps/ADFS-install7.png)

配置ADFS
![](/images/5.SecOps/ADFS-install8.png)
![](/images/5.SecOps/ADFS-install9.png)
![](/images/5.SecOps/ADFS-install10.png)
![](/images/5.SecOps/ADFS-install11.png)
![](/images/5.SecOps/ADFS-install12.png)
![](/images/5.SecOps/ADFS-install13.png)
![](/images/5.SecOps/ADFS-install14.png)
![](/images/5.SecOps/ADFS-install15.png)
![](/images/5.SecOps/ADFS-install16.png)
![](/images/5.SecOps/ADFS-install17.png)
注意，如果看到上图中红框标记的错误，则到Powershell里执行下面的命令：
```
setspn -a host/localhost adfssvc
```
![](/images/5.SecOps/ADFS-install18.png)

在powershell里执行下面的命令：
```
Set-ADFSProperties -EnableIdPInitiatedSignonPage:$true
```
9. 在powershell下载FederationMetadata.xml文件。
wget https://<你的主机名>.secworkshop.com/FederationMetadata/2007-06/FederationMetadata.xml -OutFile FederationMetadata.xml

### 配置SAML 2.0
下面通过SAML 2.0把AWS和Windows AD (使用ADFS IDP) 构建信任关系。
1. 创建IAM身份提供商： https://console.aws.amazon.com/iamv2/home?#/identity_providers/create

提供商名称一栏输入：secworkshopId，点击【选择文件】按钮，并选择上面一步中所下载的FederationMetadata.xml文件。点击【添加提供商】按钮。
![](/images/5.SecOps/SAML-Id1.png)
2. 创建role，并指定SAML 2.0身份联合： https://console.aws.amazon.com/iam/home#/roles$new?step=type&roleType=saml
![](/images/5.SecOps/SAML-Id2.png)
权限选择“AmazonS3FullAccess”
![](/images/5.SecOps/SAML-Id3.png)
“添加标签 (可选)”页面保持缺省，点击【下一步：审核】
“角色名称”设置为：secworkshopId
![](/images/5.SecOps/SAML-Id4.png)
点击【创建角色】按钮。

### 在ADFS 3.0 IdP里插入SAML assertion规则
1. 创建AD组，AD组的命名规则为：AWS-\<AccountID\>-\<IAMRolename\>，比如我们在上面创建的角色名称为：secworkshopId，假设AccountID为123456789012，则该AD组的名称为：AWS-123456789012-secworkshopId。
![](/images/5.SecOps/AD-Group1.png)
![](/images/5.SecOps/AD-Group2.png)
2. 创建AD用户：```ldapuser1```，并把该用户加入第一步中创建的AD组里。
![](/images/5.SecOps/AD-Group3.png)
密码输入```Passw0rd!```
![](/images/5.SecOps/AD-Group4.png)
![](/images/5.SecOps/AD-Group5.png)
![](/images/5.SecOps/AD-Group6.png)
![](/images/5.SecOps/AD-Group7.png)
为该用户添加email邮箱地址：
![](/images/5.SecOps/AD-Group8.png)
3. 添加Relying Party Trust
![](/images/5.SecOps/adfs-rule1.png)
![](/images/5.SecOps/adfs-rule2.png)
![](/images/5.SecOps/adfs-rule3.png)
federation metadata address输入：```https://signin.aws.amazon.com/static/saml-metadata.xml```
![](/images/5.SecOps/adfs-rule4.png)
![](/images/5.SecOps/adfs-rule5.png)
![](/images/5.SecOps/adfs-rule6.png)
![](/images/5.SecOps/adfs-rule7.png)
![](/images/5.SecOps/adfs-rule8.png)
4. 添加规则
![](/images/5.SecOps/adfs-claim1.png)
点击【Add Rule...】按钮，依次添加以下规则：

Name Id：
![](/images/5.SecOps/adfs-claim2.png)
![](/images/5.SecOps/adfs-claim3.png)

RoleSessionName：
![](/images/5.SecOps/adfs-claim4.png)
Outgoing Claim Type输入：```https://aws.amazon.com/SAML/Attributes/RoleSessionName```
![](/images/5.SecOps/adfs-claim5.png)

Get AD Groups：
![](/images/5.SecOps/adfs-claim6.png)
在customer rule文本框里输入：
```
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname", Issuer == "AD AUTHORITY"]
=> add(store = "Active Directory", types = ("http://temp/variable"), query = ";tokenGroups;{0}", param = c.Value);
```
![](/images/5.SecOps/adfs-claim7.png)

Roles：
![](/images/5.SecOps/adfs-claim8.png)
在customer rule文本框里输入：
```
c:[Type == "http://temp/variable", Value =~ "(?i)^AWS-([\d]{12})"] => issue(Type = "https://aws.amazon.com/SAML/Attributes/Role", Value = RegExReplace(c.Value, "AWS-([\d]{12})-", "arn:aws:iam::$1:saml-provider/secworkshopId,arn:aws:iam::$1:role/"));
```
![](/images/5.SecOps/adfs-claim9.png)
5. 验证Idp，确认能够通过ADFS方式登录。
下载firefox，输入地址：```https://<windows-hostname>/adfs/ls/IdpInitiatedSignOn.aspx```
![](/images/5.SecOps/adfs-verify1.png)
![](/images/5.SecOps/adfs-verify2.png)
![](/images/5.SecOps/adfs-verify3.png)

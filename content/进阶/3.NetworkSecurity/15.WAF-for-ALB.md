---
title: "配置 WAF 保护 Application Load Balancer "
chapter: false
weight: 39
tags:
  - advanced
---

通常 AWS 建议将 CloudFront Distribution 作为最终用户访问 Web 应用的入口， 因为 CDN 的分布式特性具有天然的 DDoS 攻击防护能力，ALB 作为 CloudFront Distribution 的源站，不直接对互联网暴露。

如何确保 ALB 只接受 CloudFront 的回源请求，通常有两种方式：

1.将所有 CloudFront 的 IP 地址段添加到 ALB 的安全组上。这种方式运维管理较为复杂，且需要监控 AWS IP Range 的变化，及时更新 ALB 的安全组。

2.在 CloudFront 上为回源的 HTTP Request 自定义一个 header，通过 ALB 上关联的 WAF 自定义规则，拦截不包含自定义 header 的请求。可以定义一个静态的header，也可以借助 AWS Secrets Manager 服务将 header value 作为一个密钥托管，并定期轮换，避免该 header 泄漏，被恶意用户通过伪造 http 请求而直接攻击 ALB，具体可参照[此博客](https://aws.amazon.com/blogs/security/how-to-enhance-amazon-cloudfront-origin-security-with-aws-waf-and-aws-secrets-manager/).

本章节将以第2种方法为例，介绍如何利用 AWS WAF 保护 Application Load Balancer，采用配置一个静态的自定义 header，实现 ALB 只接受 CloudFront 的回源请求，步骤如下：

 - 在 CloudFront 上为回源的 HTTP Request 自定义一个 header（key/value）
 - 定义 WAF 规则，检查 http header，只允许存在自定义header的请求，block 其他请求
 - 将 WAF 关联到 ALB
 - 验证 WAF 规则生效情况


## 在 CloudFront Distribution 添加自定义回源 header

CloudFront 是基于每个 Distribution 中的每个源站去配置回源的自定义 header，支持添加多个自定义 header。

1. 进入 CloudFront 控制台：https://console.aws.amazon.com/cloudfront/home
2. 找到“注释”为“Cloudfront-for-WP”的Distribution，进入详细信息页面。
3. 点击“源和源组”页面，选中其中关联了ALB的源。
4. 然后点击【编辑】按钮。

![](/images/3.NetworkSecurity/WAF-ALB-0.png)

在“源自定义标头”部分添加自定义的标头：

 - 标头名称: secworkshop
 - 值: gobuild

点击【是,请修改】按钮。这个修改需要5分钟左右生效。
![](/images/3.NetworkSecurity/WAF-ALB-1.png)

## 创建 WAF Web ACL

#### 第一步，创建新的 WAF Web ACL
首先进入 AWS WAF Console，创建 Web ACL：https://console.aws.amazon.com/wafv2/homev2/web-acls/new?region=ap-northeast-1

- Name: 输入WebACL的Name，这里输入：WAF-ALB
- Resource Type： 选择 Regional resources
- Region: 选择被保护资源所在的 ，这里选择“Asia Pacific (Tokyo)”

![](/images/3.NetworkSecurity/WAF-ALB-2.png)

点击【Next】按钮。

#### 第二步，创建自定义规则

1. 在“Add rules”下拉菜单选择“Add my own rules and rule groups”选项。
配置自定义的 WAF 规则：

 - Rule type：保留缺省的“Rule builder”选项
 - Name: verify-header
 - Type: Regular rule
 - If a request: doesn't match the statement (NOT)
 - Inspect: Header
 - Header field name：输入“secworkshop”
 - Match Type: Exactly matches string
 - String to Match: gobuild
 - Action: Block

![](/images/3.NetworkSecurity/WAF-ALB-3.png)

点击【Add rule】按钮。

2.回到“Add rules and rule groups”页面，点击【Next】按钮

3.进入“Set rule priority”页面，保留缺省值，继续点击【Next】按钮

4.进入“Configure metrics”页面，保留缺省值，继续点击【Next】按钮

5.进入“Review and create web ACL”页面，点击【Create web ACL】按钮


#### 第三步，将 WAF 关联到 ALB

1. 在WAF控制台上，点击Web ACL，点击我们在上一步中创建的“WAF-ALB” ACL。
2. 在“Associated AWS resources”页面上，选择【Add AWS resources】按钮
3. 在“Add AWS resources”页面上，选择“Application Load Balancer”，并选择名为“wordpress-alb”的ALB。
4. 点击【Add】按钮。

 ![](/images/3.NetworkSecurity/WAF-ALB-4-1.png)

 ![](/images/3.NetworkSecurity/WAF-ALB-4.png)

## 验证 WAF 规则生效情况

打开Cloud9 IDE，并输入下面的命令，确认能够通过CloudFront对页面入口进行正常访问：http://\<WordpressApplicationURL>/wp-admin/
```
curl http://d2avv37lq284rd.cloudfront.net/wp-admin/
```
然后通过ALB来访问页面入口，则提示403 Forbidden，被 WAF 规则阻止：http://\<LoadBalancerUrl>/wp-admin/
```
curl http://wordpress-alb-586696891.ap-northeast-1.elb.amazonaws.com/wp-admin/
```
确认其输出如下：
```
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
</body>
</html>
```

{{% notice note %}}
这里的\<LoadBalancerUrl>可以在[部署动手实验示例应用程序]({{< ref "基础/3.networksecurity/11.deployapps.md" >}})部分中的CloudFormation堆栈部署完毕后的输出中找到。
{{% /notice  %}}

查看 Cloud9 IDE 对应的 Public IP.
```
curl ifconfig.me
```

在WAF控制台上，点击Web ACL，点击我们在上一步中创建的“WAF-ALB” ACL。
在 Overview 页面中，查看Sample Request，可以看到该 IP 发起的请求，由于匹配 verify-header WAF 规则被 BLOCK.

 ![](/images/3.NetworkSecurity/WAF-ALB-5.png)
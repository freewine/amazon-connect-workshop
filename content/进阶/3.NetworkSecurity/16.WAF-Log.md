---
title: "启用 WAF 日志并使用 Elasticsearch 分析 "
chapter: false
weight: 40
tags:
  - advanced
---

AWS WAF 提供请求日志来记录相关 WebACL 流量的详细信息，日志信息包括被请求的 AWS 资源，每个请求的详细 HTTP 信息，以及每个请求匹配的规则和动作，具体日志字段请参考[官方文档](https://docs.aws.amazon.com/zh_cn/waf/latest/developerguide/logging.html)。

启用日志记录后，AWS WAF 的请求日志将通过用户配置的 Amazon Kinesis Data Firehose 传输到目标存储位置，例如 S3， Elasticsearch 等。

{{% notice note %}}
用来接收 WAF 请求日志的 Amazon Kinesis Data Firehose，名称必须以 ```aws-waf-logs-```开头。

为用于保护Amazon CloudFront 的 WAF WebACL 启用日志，必须在美东区域（弗吉尼亚）中创建 Firehose。

为用于保护 ALB，API Gateway 等区域性资源的 WAF WebACL 启用日志，必须在相对应的区域中创建 Firehose。
{{% /notice  %}}


本章节将以用于保护 CloudFront 的 WAF WebACL 举例，介绍如何为 WAF 启用日志，以及使用 Elasticsearch 分析日志。其中 Elasticsearch 将使用在 ‘启用 CloudFront 实时日志并使用 Elasticsearch 分析‘ 章节中创建的 ES 集群。

本实验会使用下面的附件，可以先把这些文件下载到本地。
{{%attachments title="下载链接:" /%}}

## 创建 Kinesis Data Firehose

进入并创建位于us-east-1的Kinesis Data Firehose控制台：https://console.aws.amazon.com/firehose/home?region=us-east-1#/wizard/nameAndSource

1.在“新的传输流”页面上：

- 传输流名称: aws-waf-logs-demo
- 源： Direct PUT或其他源（默认）
点击【下一步】按钮。

![](/images/3.NetworkSecurity/WAF-Log-1.png)

2.在“处理记录”页面上：

- 数据转换： 禁用（默认）
- 记录格式转换：禁用（默认）
点击【下一步】按钮。

3.在“选择一个目标”页面上：

- 目标：Amazon Elasticsearch
- 域：选择在‘CloudFront 实时日志’章节中创建的、名为“secworkshop”的Elasticsearch域
- 索引：awswaf
- 索引轮换：每天
- VPC：Elasticearch所在的VPC，ES-Sample（默认）
- 子网：ES-Sample VPC的两个子网（默认）
- 安全组：ElasticseaerchSecurityGroup（默认）
- 备份模式：仅失败的记录，
- 备份 S3 存储桶：选择最初创建的、名称为“<你的姓名拼音首字母>-secworkshop”的S3桶
- 备份 S3 存储桶前缀：awswaflog
点击【下一步】按钮。

![](/images/3.NetworkSecurity/WAF-Log-2.png)

4.在“配置设置”页面上：

- 缓冲区大小：1MiB
- 缓冲时间间隔：60s
- 权限-IAM角色：创建或更新IAM角色（默认）
其他保留缺省值，点击【下一步】按钮。

5.在“审核”页面上，点击【创建传输流】按钮。这个过程大约需要3分钟。

## 启用 WAF 日志

1. 在 Kinesis Data Firehose 创建完成后，进入 AWS WAF 控制台的Web ACL界面：https://console.aws.amazon.com/wafv2/homev2/web-acls?region=global
2. 点击“WAF-CloudFront”，进入详细界面。
3. 点击并进入“Logging and Metrics”页面。
4. 点击【Enable logging】按钮。
5. 点击【Select a delivery stream】按钮，选择上一步创建的Kinesis Data Firehose ```aws-waf-logs-demo```。
6. 其他配置保留缺省值，点击【Enable logging】按钮。

![](/images/3.NetworkSecurity/WAF-Log-3.png)

## 使用 Elasticsearch 分析 WAF 日志

首先需要在 Kibana 中，为用于传送 WAF 日志的 Kinesis Data Firehose 的 IAM Role 添加权限。

{{% notice note %}}
关于如何登录 Kibana，请参考章节 ‘启用CloudFront实时日志并使用Elasticsearch分析‘
{{% /notice  %}}

进入上一步中创建的kinesis data firehose的详细页面：https://console.aws.amazon.com/firehose/home?region=us-east-1#/details/aws-waf-logs-demo

找到权限部分，点击IAM角色，打开IAM控制台
![](/images/3.NetworkSecurity/WAF-Firehose-1.png)

把这个角色的ARN拷贝下来。
![](/images/3.NetworkSecurity/WAF-Firehose-2.png)

登录 Kibana，点开菜单，点击左边的“Security”选项，点击左边的“Roles”选项，在右边找到“all_access” role。
点击“all_access”，并点击“Mapped users”页面，点击【Manage mappings】按钮，
点击【Add another backend role】按钮，将 Firehose 的IAM Role ARN复制到Internal User 或者 Backend Role 均可，然后点击【Map】按钮即可。

![](/images/3.NetworkSecurity/WAF-Log-4.png)

然后需要使用 Index template 修改 WAF Log 对应的Mapping字段格式，否则将无法将 log 的 timestamp 字段识别为时间格式。

点开 Kibana 菜单，并选择“Dev Tools”，将下面内容复制到左边窗口，然后执行图标。
```
PUT  _template/awswaf-logs
{
  "index_patterns": [
    "awswaf-*"
  ],
  "mappings": {
    "properties": {
      "httpRequest": {
        "properties": {
          "clientIp": {
            "type": "keyword",
            "fields": {
              "keyword": {
                "type": "ip"
              }
            }
          }
        }
      },
      "timestamp": {
        "type": "date",
        "format": "epoch_millis"
      }
    }
  }
}
```
![](/images/3.NetworkSecurity/WAF-Log-5.png)

接下来创建 Index pattern。
登录 Kibana，点开菜单，点击左边的“Stack Management”选项，再点击“Index Patterns”选项，点击右边的“Create index pattern”按钮，输入 ```awswaf-*```，点击【Next step】按钮。

{{% notice note %}}
在Kibana中创建 Index Pattern 时，如果提示 no data，则请对被 WAF 保护的 Web URL 发起几次请求，主动生成几条日志.
{{% /notice  %}}

![](/images/3.NetworkSecurity/WAF-Log-6.png)
![](/images/3.NetworkSecurity/WAF-Log-6-1.png)

选择 timestamp 字段作为 Time field。点击【Create index pattern】按钮。

从本次实验开始时，下载的文件中，找到名为“awswaf-dashboard.ndjson”的文件，
这是个用于 AWS WAF 日志可视化展示的 Kibana 模版文件。

在Kibana菜单上，进入“Stack Management”选项，然后点击“Saved Object”选项，在右边点击“Import”选项，选中“awswaf-dashboard.ndjson”文件，点击【Import】按钮。
其他设置保留默认配置，如果提示Index Pattern Conflict，则从下拉菜单中选择对应的Index pattern。
{{% notice note %}}
在导入的 objects 中，也会有一个```awswaf-*``` index pattern，其中会多出两个 Scripted field 字段，分别为 Host 和 UserAgent， Dashboard 中有些视图会使用到这两个字段。
{{% /notice  %}}

![](/images/3.NetworkSecurity/WAF-Log-7.png)

在Kibana菜单上，进入“Dashboard”选项，在右侧的窗口里找到、并点击名为“WAFDashboard”的dashboard，然后查看 CloudFront 实时日志可视化视图。

![](/images/3.NetworkSecurity/WAF-Log-8.png)






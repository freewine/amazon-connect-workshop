---
title: "使用Connect对Root账户登录进行电话报警"
chapter: false
weight: 29
tags:
  - advanced
---

### 背景
用户在使用AWS云服务的时候，需要对关键服务的性能、可靠性等指标进行实时监控，在出现监控指标异常的时候，需要及时通知云管理人员，对异常服务进行查看并修复。
越来越多的用户把生产环境部署在云端，这就要求云端业务需要7X24处于可用状态，即便目前AWS平台已经有了使用邮件、短信通知等方式发送告警的功能，但是在一些重大事件发生的时候，用户还是希望AWS平台能够直接拨打相关运维人员的手机，以便更快速地进行告警发送。
在这篇文章中，我们会探讨在AWS上使用Amazon Connect服务，结合CloudWatch监控，在出现Root账户登录时候，拨打相关人员的电话，达到及时通知的目的。学员可以扩展该实验应用到其它场景，例如核心服务器停止，ALB响应时间过长等等。

{{% notice note %}}
注意，如果配置的Amazon Connect外呼的电话号码不属于美国境内，比如需要把告警事件外呼到国内的电话号码上，则需要提交案例，请AWS Support团队进行开通。
{{% /notice  %}}

### 数据流和架构
数据处理流程以及系统概要架构如下所示：
![](/images/2.OperationMonitor/Connect_architecture.png)

### 部署步骤

{{% notice note %}}
为了更快的验证Amazon Connect的电话通知效果，下面的实验，我们在美东region(us-east-1)完成。
{{% /notice  %}}

#### 配置Amazon Connect 服务相关功能
1. 进入Connect的初始化控制台： https://us-east-1.console.aws.amazon.com/connect/onboarding?region=us-east-1
，选中“将用户存储在 Amazon Connect 中”单选框，并指定URL为：secworkshop，点击【下一步】按钮，如下图所示。
![](/images/2.OperationMonitor/initconnect1.png)
2. 在“创建一个管理员”页面上，选择“添加新管理员”，输入用户名、密码以及邮箱以后，点击【下一步】按钮。
![](/images/2.OperationMonitor/initconnect2.png)
3. 在“通话选项”页面上，保留缺省值。点击【下一步】按钮。
![](/images/2.OperationMonitor/initconnect3.png)
4. 在“数据存储”页面上，保留缺省值。点击【下一步】按钮。
![](/images/2.OperationMonitor/initconnect4.png)
5. 在“审核与创建”页面上，点击【创建实例】按钮。
![](/images/2.OperationMonitor/initconnect5.png)
6. 等待一到两分钟后，实例创建成功。点击页面提供的链接登入刚刚创建的AWS Connect控制平面，并点击右上角的English，切换为中文。
![](/images/2.OperationMonitor/initconnect6.png)
![](/images/2.OperationMonitor/connect_login.jpg)
7. 在**控制面板**的右上角，**申请一个电话号码**点击右侧的【**开始**】按钮。
![](/images/2.OperationMonitor/connect_applyphone1.png)
8. 在申请电话号码页面上，在“国家”下拉列表里，选择“美国”，“类型”选择“免费”，“电话号码”选择一个可用的号码，并将号码保存到文本文件备用。点击【下一步】按钮。在后面的页面上，点击【skip for now】按钮，跳过后续可选的配置步骤。
![](/images/2.OperationMonitor/connect_applyphone.jpg)
9. 回到**控制面板**,选择**5.创建联系流**，在这里我们可以定义拨出电话需要自动执行的相关指令，我们点击“**查看联系流**”链接，进入到联系流的控制界面，然后点击右上角【**创建联系流**】按钮。
10. 联系流的设置是一种积木式的图形化操作。分别从设置中选中并拖拽**设置语音**到画布上, 从“交互”中选中并拖拽**播放提示**到画布上，从“终止/转接”中选中并拖拽**断开连接**到画布上，以如下图所示方式，用鼠标点击的方将几个组件按顺序用箭头连接起来。
![](/images/2.OperationMonitor/connect_flow.jpg)
11. 然后我们将分别设置各个组件。点击**设置语音**,在弹出页面中将语言设置为Chinese, Mandarin
12. 点击**播放提示**，播放提示可以让电话被接通之后，播放自定义的语音，在这里我们选择**文本到语音转换或聊天文本**，**动态输入**，类型选择**用户定义**，属性设为“rootloginalarm”,解释为**SSML**，点击【Save】按钮。如下图所示，这个配置的意思是我们可以动态调整语音提示的内容，本篇文章会在后面的Lambda函数中演示如何动态的设置提示语音。
![](/images/2.OperationMonitor/connect_play1.png)
13. 在左上角为这个联系流设置一个名称，如rootloginalarm_fl, 点击右上角【**保存**】按钮，保存成功以后，点击【**发布**】按钮。
![](/images/2.OperationMonitor/connect_process1.png)
14. 发布成功以后，注意左侧生成的ARN,它的格式为arn:aws:connect:us-east-1:*ACCOUNT_ID*:instance/*INSTANCE_ID*/contact-flow/*FLOW_ID*,将它拷贝到文本文件中备用
![](/images/2.OperationMonitor/connect_arn1.png)
#### 设置Lambda程序调用之前创建的联系流
1. 进入IAM角色的控制台，为Lambda函数创建角色，从而让Lambda有权限调用联系流： https://console.aws.amazon.com/iam/home?region=us-east-1#/roles$new?step=type
2. 选择最上方**AWS 产品**,选择**Lambda**，点击**下一步：权限**
3. 在权限策略页面，搜索并勾选“AmazonConnect_FullAccess”以及“AWSLambdaBasicExecutionRole”，点击**下一步：标签**
4. 跳过标签设置，进入审核页面，填写角色名为：lambda-connect-role，点击**创建角色**。
5. 进入创建Lambda函数的控制台： https://us-east-1.console.aws.amazon.com/lambda/home?region=us-east-1#/create/function
，输入函数名为“cloudwatch_alarm_call_out_lambda”,运行语言选择Python3.8，权限一栏选择**使用现有角色**，然后在现有角色的下拉框中选中在上一步中创建的、名为lambda-connect-role的IAM角色，点击【创建函数】按钮，创建出空白的Lambda函数。
6. 将下面代码粘贴入代码区，注意替换里面的信息
  ```python
  import json
  import boto3

  client = boto3.client('connect')

  def lambda_handler(event, context):
      info= '<speak><break time="3s"/>主账号登录警报，请立即查看。主账号登录警报，请立即查看。+</speak>'
      response = client.start_outbound_voice_contact(
      DestinationPhoneNumber='+8611111111111', #这里替换为你要拨打的电话号码
      InstanceId='0b6fa8fd-31fb-49c0-8242-f02c7c2513d0', #这里替换为你的联系流ARN中的INSTANCE_ID
      ContactFlowId='148ecfd1-5fc4-4693-a42b-6db134de6ae1', #这里替换为你的联系流ARN中的FLOW_ID
      SourcePhoneNumber='+18025528913', #这里替换为你在Connect中申请的电话
      Attributes={
          'rootloginalarm': info
      }
      )
      
      return {
          'statusCode': 200,
          'body': json.dumps(response)
      }
  ```
7. 点击**Deploy**按钮，将代码发布备用
#### 设置Cloudwatch 监控用户登录
在生产环境中，我们最多监控的是root账户，但对于实验来说监控root账户不容易验证，所以我们暂时改为监控某一个普通的iam用户登录，比如在前面的实验中创建的“security_user”为例。
1. 进入CloudWatch中的、创建事件规则的控制面板，然后创建规则: https://us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#rules:action=create
2. 选择**事件模式**，服务名称选择"AWS 控制台登录", 选择**按ARN 的特定用户**，在下方的输入框中填入被监控的用户ARN，可以从这里找到security_user的ARN： https://console.aws.amazon.com/iam/home?region=us-east-1#/users/security_user
，例如: arn:aws:iam::*ACCOUNT_ID*:user/security_user. 如果是root用户，这个arn的格式为arn:aws:iam::*ACCOUNT_ID*:root
3. 点击右侧目标中选择**Lambda 函数**,并选择我们之前创建的lambda函数：
![](/images/2.OperationMonitor/connect_cloudwatch.jpg)
4. 点击右下角**配置详细信息**按钮。
5. 在“步骤 2: 配置规则详细信息”页面上，为“名称”一栏输入：iam-connect-alarm。点击【创建规则】按钮。
6. 至此，我们已经完成了所有的设置。测试的方法就是使用被监控的用户，也就是security_user，然后尝试登录控制台，无论登录是否成功，都会有电话拨入到lambda中设定的电话中。
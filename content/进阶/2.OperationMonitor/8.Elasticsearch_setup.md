---
title: "把CloudTrail日志实时传入Elasticsearch"
chapter: false
weight: 28
tags:
  - advanced
---

本次实验包括创建Elasticsearch集群，以及如何设置CloudTrail日志到Elasticsearch集群的数据输入。

## 创建Elasticsearch 域
{{% notice warning %}}
此过程简要介绍了如何配置测试域。不应使用它来创建生产域。
{{% /notice  %}}

1. 进入Elasticsearch控制台，并创建Elasticsearch域：https://ap-northeast-1.console.aws.amazon.com/es/home?region=ap-northeast-1#create-domain 
2. 在步骤1的“**选择部署类型**”的页面上，选择“**开发和测试**”选项。“**Elasticsearch 版本**”保留缺省值，点击【**下一步**】按钮。
![](/images/2.OperationMonitor/elasticsearch_creation1.png)
3. 在步骤2的“配置域”的页面上，“**Elasticsearch 域名**”设置为“**cloudtrailes**”，其他选项保留缺省值，点击【**下一步**】按钮。
![](/images/2.OperationMonitor/elasticsearch_creation2.png)
4. 在步骤3的“**配置访问和安全**”页面上，“**网络配置**”选项中，选择“**VPC访问**”，具体“**VPC**”选择“**SecWorkshopVPC**”，“**子网**”选择“**PublicSubnet1**”，“**安全组**”选择“**SecWorkshopVPC-BastionSecurityGroup**”

对于“**精细访问控制**”，选择“**创建主用户**”单选框，主用户名输入“**admin**”，主密码和确认主密码输入“**P@ssw0rd**”。 

在“**域访问策略**”里，选择“**JSON定义的访问策略**”，输入下面的内容。其他保留缺省值。点击【**下一步**】按钮。
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "*"
      },
      "Action": "es:*",
      "Resource": "*"
    }
  ]
}
```
![](/images/2.OperationMonitor/elasticsearch_creation3.png)
5.在步骤4的“**审核**”页面上，点击【**确认**】按钮，等待Elasticsearch集群的创建，大约需要10分钟。
![](/images/2.OperationMonitor/elasticsearch_creation4.png)

## 配置数据源
这里我们使用上面章节创建的cloudtrail日志信息作为数据源，通过Elasticsearch 对cloudtrail 日志进行图形化展现。

1. 进入IAM控制台，创建一个Lambda role 用于将日志写入：https://console.aws.amazon.com/iam/home?region=ap-northeast-1#/roles$new?step=type
2. 点击左侧**角色**并点击**创建角色**按钮
3. 选择 **Lambda** 作为案例并点击 **下一步**
4. 在搜索栏输入*AWSLambdaVPCAccessExecutionRole* 并勾选，点击**下一步**
5. 在添加标签页点击**下一步**
6. 输入角色名 lambda_cloudtrailes_role, 并点击**创建角色**
7. 完成后拷贝role 的arn备用 arn:aws:iam::<你的account id>:role/lambda_cloudtrailes_role
8. 通过以下网址打开 CloudWatch 控制台：https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups$3FlogGroupNameFilter$3Daws-cloudtrail-logs-tokyo
9. 找到我们之前为cloudtrail创建的日志组并选中，点击右上方**操作**并选择 **创建Elasticsearch 订阅筛选条件**
![](/images/2.OperationMonitor/elasticsearch_cloudwatch.jpg)
10. 在弹出的筛选条件页面中，选择 **This account (当前账户)**
11. 在 **Amazon ES cluster**中选择刚刚创建的 *cloudtrailes*, 如果domain仍处于创建过程中需要等待一些时间
12. 在**Lambda IAM execution Role**中选中之前创建的lambda_cloudtrailes_role
13. 在**日志格式中**选择 AWS CloudTrail
14. 在**订阅筛选条件名称**中输入 *cloudtrailesfilter*
15. 点击右下角 的【开始流式传输】按钮

![](/images/2.OperationMonitor/cloudwatch_log_es.png)

## 使用 Kibana 显示Elasticsearch里的数据

### 配置SSH隧道

进入EC2控制台，找到我们创建的跳板机，并把它的公网ip地址拷贝下来：https://ap-northeast-1.console.aws.amazon.com/ec2/v2/home?region=ap-northeast-1#Instances:instanceState=running;search=BastionInstance

进入Elastisearch控制台，记录Kibana的域名：https://ap-northeast-1.console.aws.amazon.com/es/home?region=ap-northeast-1#domain:resource=cloudtrailes;action=dashboard;tab=undefined


下面介绍如何通过 SSH 隧道访问 VPC 内的 Kibana。如果是mac电脑，则执行下面的命令：
```
## 此 SSH 隧道将本地的 9200 端口代理到远端 Kibana URL 的443端口
ssh -i <你的姓名拼音首字母>-secworkshop.pem ec2-user@<跳板机的公网ip> -N -L 9200:<cloudtrailes集群的域名>:443
```
如果是windows电脑，请下载putty工具到本地，并启动该工具。该工具可以无需安装，直接执行。因为putty需要用到ppk格式的keypair，如果你是下载的pem格式，则使用puttygen工具进行转换。
{{%attachments title="下载链接:" /%}}

a.启动putty以后，从CloudFormation 输出中记录的 SSH 隧道连接方式中，输入ec2-user@<跳板机的公网ip>，如下图所示。
![](/images/2.OperationMonitor/putty1.png)

b.在左边点开“Connection”，再点开“SSH”，再点开“Auth”，在右边的“private key file”一栏，点击【Browse...】按钮，选择你的keypair文件：<你的姓名拼音首字母>-secworkshop。
![](/images/2.OperationMonitor/putty2.png)

c.在左边点击“Tunnels”，在右边的“Source port”里，输入端口：9200。

然后在Destination一栏输入Kibana的域名，可以从CloudFormation 输出中记录的 SSH 隧道连接方式中找到，比如：vpc-secworkshop-c4agv6xpwokgy7zqq5avlfpgli.us-east-1.es.amazonaws.com:443
![](/images/2.OperationMonitor/putty3.png)

d.点击【Add】按钮，把source port和destination的内容添加到列表里。
![](/images/2.OperationMonitor/putty4.png)

e.点击【Open】按钮，建立到跳板机的SSH隧道。

## Kibana 配置
1. 在本地浏览器中，打开```https://localhost:9200/_plugin/kibana/```，输入创建Elasticsearch集群时所指定的用户名和密码，默认为 ```admin / P@ssw0rd``` .
![](/images/3.NetworkSecurity/Cf-realtimelog-KibanaLogin.png)
2. 如果有弹出欢迎页面，点击 Explore on my own
3. 点击左上角菜单按钮，选择 **Security**
4. 点击左侧 **Roles** 并在role列表中点击 all_access 链接
5. 在新页面中点击上方**Mapped users**, 然后点击右侧 **Manage mapping**
6. 在 **Backend Roles** 中将 lambda_cloudtrailes_role 的ARN （可以通过IAM控制台：https://console.aws.amazon.com/iam/home?region=ap-northeast-1#/roles/lambda_cloudtrailes_role
进行拷贝）粘贴到文本框中,然后点击右下角 **Map**按钮
![](/images/2.OperationMonitor/kinbana_role.png)
7. 点击左上角菜单按钮，点击 **Discover**，此时系统提示没有index信息
8. 点击右上角 **Create index pattern** 按钮
9. 在**Index pattern name** 中输入 cwl-*, 点击 【Next step】
10. 在 Time field 中选择 @timestamp， 并点击 **Create index pattern**
11. 系统显示所有cloudtrail 字段
![](/images/2.OperationMonitor/kinbana_result.png)
12. 点击左上角菜单按钮，点击 **Discover**, 确认日志信息已经进入ES
![](/images/2.OperationMonitor/kinbana_discover.jpg)

---
title: "使用CloudWatch分析审计日志"
chapter: false
weight: 62
tags:
  - beginner
---

本节将介绍如何利用CloudWatch分析和展示日志。

### 利用CloudWatch分析和展示日志{#cw_audit_log}
开启RDS的日志导出选项以后，就可以在CloudWatch服务里面查看和分析日志。
#### 在CloudWatch Log中查看日志
1. 打开CloudWatch日志组，过滤wordpress关键字，然后点击RDS实例的Audit日志链接
![日志组](/images/6.DatabaseAudit/4.2.1.log-management-of-rds-mysql.png)
2. 查看RDS Audit日志，点击日志链接
![RDS Audit日志一览](/images/6.DatabaseAudit/4.2.2.log-management-of-rds-mysql.png)
3. 可以看到Audit日志的具体内容，也可以用双引号括起来关键词进行筛选
![RDS Audit日志内容](/images/6.DatabaseAudit/4.2.3.log-management-of-rds-mysql.png)
![RDS Audit日志筛选](/images/6.DatabaseAudit/4.2.4.log-management-of-rds-mysql.png)

#### 利用CloudWatch见解进行日志监控
RDS Audit日志是逗号分隔的CSV文件，可以在“CloudWatch见解(Log Insights)”中查询和可视化。

CloudWatch见解的语法规则可以参考这个[链接](https://docs.aws.amazon.com/zh_cn/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)。

1. 在下拉菜单中选择要分析的日志组，这里选择带有wordpress关键字的日志组。
![CW见解](/images/6.DatabaseAudit/4.2.5.log-management-of-rds-mysql.png)

通过正则表达式解析Audit日志各个字段
各个字段如下：

时间戳 | 服务器 | 用户 | 客户端 | 连接id | 查询id | 操作 | 数据库 | sql语句 | 返回码
--- | --- | --- | --- | --- | --- | --- | --- | --- | ---
time | server | user | client | conid | qryid | oper | db | sql | code

除了**sql**字段以外，其它字段内都没有逗号，所以可以用下面的语句
```perl
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
```

2. 解析完成之后，就能以各字段为筛选条件对日志进行查询。比如，查询所有正常完成的insert操作：
```perl
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter sql like /(?i)^\'\s*insert\s/ and code=0
```
![CW见解筛选](/images/6.DatabaseAudit/4.2.6.log-management-of-rds-mysql.png)

3. 还可以加上统计函数和时间桶，计算单位时间内满足筛选条件的记录数目
```perl
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter sql like /(?i)^\'\s*insert\s/ and code=0
| stat count(*) by bin(5m)
```
![CW见解统计](/images/6.DatabaseAudit/4.2.7.log-management-of-rds-mysql.png)

4. 点击**可视化**标签，可以看到图形化展示的折线图
![CW见解折线图](/images/6.DatabaseAudit/4.2.8.log-management-of-rds-mysql.png)

5. 在**可视化**页面上，点击【添加到控制面板】按钮，从而把可视化组件添加到控制面板，并保存好控制面板

可以用带时间轴的折线图展示各种查询的数量随时间的推移变化。也可以筛选一些日志字段显示在表里。
比如执行下面的查询命令，显示错误日志的内容:
```perl
# 解析RDS错误日志，以1分钟粒度显示时间推移图
parse @message "* * * *" as time, thread, label, msg
| stats count() as err_cnt by bin(1m)
```

然后在**可视化**页面上，点击【添加到控制面板】按钮，在“选择控制面板”部分，点击“新建”链接，
指定“secworkshop”为控制面板的名称。并在“自定义小部件标题”部分输入“RDS Error”。
点击【添加到控制面板】按钮。
![CW控制面板](/images/6.DatabaseAudit/controlpanel-log-insights01.png)

依次把下面的查询都添加到控制面板里：
```perl
# 解析RDS错误日志，以1分钟粒度显示时间推移图
parse @message "* * * *" as time, thread, label, msg
| stats count() as err_cnt by bin(1m)

# 解析RDS错误日志，展示成表格
parse @message "* * * *" as time, thread, label, msg

# 解析RDS审计日志，以1分钟粒度显示成功操作和失败操作的时间推移图
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter oper='QUERY' | fields (code=0) as code_succ, (code!=0) as code_fail
| sum(code_succ) as oper_succ, sum(code_fail) as oper_fail by bin(1m)

# 解析RDS审计日志，显示错误操作的表格
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter oper='QUERY' and code!=0)

# 解析RDS审计日志，以1分钟粒度显示各种DML的时间推移图
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter oper='QUERY' | fields sql like /(?i)^\'\s*select\s/ as select, sql like /(?i)^\'\s*update\s/ as update, sql like /(?i)^\'\s*replace\s/ as replace, sql like /(?i)^\'\s*delete\s/ as delete
| stats sum(select) as select_cnt, sum(update) as update_cnt, sum(replace) as replace_cnt, sum(delete) as delete_cnt by bin(1m)

# 解析RDS审计日志，显示DCL等命令的表格
parse @message /^(?<time>[^,]+),(?<server>[^,]+),(?<user>[^,]+),(?<client>[^,]+),(?<conid>\d+),(?<qryid>\d+),(?<oper>\w+),(?<db>[^,]*),(?<sql>.*),(?<code>\d+)$/
| filter oper='QUERY' | filter sql like /(?i)^\'\s*grant\s/ or sql like /(?i)^\'\s*alter\s/ or sql like /(?i)^\'\s*show\s/
```

![CW控制面板](/images/6.DatabaseAudit/4.2.9.log-management-of-rds-mysql.png)

#### 对CloudWatch日志设置报警
CloudWatch日志组的日志更新是准实时的，所以可以用指标筛选条件设置报警。以RDS错误日志为例：

1. 打开CloudWatch日志组，过滤wordpress关键字，然后点击RDS实例的Audit日志链接，
选中wordpress日志组，在“操作”下拉菜单里点击“创建指标筛选条件”选项。
![CW日志组](/images/6.DatabaseAudit/4.2.11.log-management-of-rds-mysql.png)

2. 以"Access denied"为关键字筛选RDS 错误登陆事件，用RDS日志样本进行测试可以看到筛选结果。点击**Next**
![定义模式](/images/6.DatabaseAudit/4.2.12.log-management-of-rds-mysql.png)
![测试结果](/images/6.DatabaseAudit/4.2.13.log-management-of-rds-mysql.png)

3. 在分配指标页面设置筛选名称**rds_errlog_acsdenied**，定义监控指标的命名空间**rds_alert**和指标名称**rds_errlog_acsdenied**，以及不匹配时的值0和匹配值1
![分配指标](/images/6.DatabaseAudit/4.2.14.log-management-of-rds-mysql.png)

4. 确认输入的内容，点击**创建指标筛选条件**
![确认指标](/images/6.DatabaseAudit/4.2.15.log-management-of-rds-mysql.png)

5. 创建CloudWatch警报
![创建警报](/images/6.DatabaseAudit/4.2.16.log-management-of-rds-mysql.png)

6. **选择指标**，选中刚才创建的**rds_errlog_acsdenied**指标，然后**下一步**
![选择指标](/images/6.DatabaseAudit/4.2.17.log-management-of-rds-mysql.png)
![选择指标](/images/6.DatabaseAudit/4.2.18.log-management-of-rds-mysql.png)

7. **指定指标和条件**，以1分钟内总数3次为阈值，下一步
![指定指标](/images/6.DatabaseAudit/4.2.19.log-management-of-rds-mysql.png)
![指定条件](/images/6.DatabaseAudit/4.2.20.log-management-of-rds-mysql.png)

8. **配置操作**，设置报警目标SNS主题，为报警设置一个邮件地址
![配置操作](/images/6.DatabaseAudit/4.2.21.log-management-of-rds-mysql.png)

9. **添加名称和描述**，输入名称alert_rds_errlog_acsdenied，然后在**预览和创建**页面**创建警报**
![添加名称](/images/6.DatabaseAudit/4.2.22.log-management-of-rds-mysql.png)

10. 可以试着3次输入错误的RDS密码，邮箱里会收到报警邮件
![报警邮件](/images/6.DatabaseAudit/4.2.23.log-management-of-rds-mysql.png)

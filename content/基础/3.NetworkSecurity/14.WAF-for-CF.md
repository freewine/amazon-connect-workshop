---
title: "配置 WAF 保护 CloudFront Distribution "
chapter: false
weight: 38
tags:
  - beginner
---

AWS WAF 是一种 Web 应用程序防火墙，可帮助保护您的 Web 应用程序或 API 免遭 Web 漏洞的攻击。可以将 AWS WAF 部署到全球性资源 Amazon CloudFront 上，或者区域级资源 Application Load Balancer、Amazon API Gateway 以及 AWS AppSync 上。

AWS WAF 允许根据多种条件，例如 IP 地址、HTTP 标头和正文或自定义 URI，以及 HTTP 请求速率，来过滤 Web 流量。

本章节将介绍如何利用 AWS WAF 保护 CloudFront Distribution。

## 创建 WAF Web ACL

#### 第一步，创建新的 WAF Web ACL
首先进入 AWS WAF Console，创建 Web ACL：
https://console.aws.amazon.com/wafv2/homev2/web-acls/new?region=us-east-1

- Name: 输入WebACL的Name，这里输入：WAF-CloudFront
- Resource Type： 选择 CloudFront distributions

点击【Next】按钮。

![](/images/3.NetworkSecurity/WAF-CF-1.png)

#### 第二步，添加 WAF 规则
添加托管 WAF 规则：AWS WAF 提供了一系列托管的规则保护常见的应用漏洞，包括 AWS Managed 和第三方安全厂商的托管规则组，可以为每个 Web ACL 从 AWS Managed Rules中选择一个或多个规则组。

##### 1. 添加AWS托管的 WAF 规则
选择两个 AWS Managed 托管规则组：

- Core rule set
- Amazon IP reputation list

点击【Add Rule】

![](/images/3.NetworkSecurity/WAF-CF-2.png)
![](/images/3.NetworkSecurity/WAF-CF-3.png)


##### 2. 添加自定义 WAF 规则
可以基于多种匹配条件，自定义 WAF 规则：

- Rule Type
    - Relugar： 基于 HTTP 请求特征
    - Rate-based： 基于 HTTP 请求速率 （单个 IP 5分钟内最大请求总数）
- Inspect
    - Country/IP 来源
    - Request header/Query/URI/Body/Method
- Match type
    - String match
    - Size match
    - SQLi/XSSi

在“Add rules”下拉菜单选择“Add my own rules and rule groups”选项。

![](/images/3.NetworkSecurity/WAF-CF-4.png)

配置两个自定义规则：

1.根据 HTTP 请求路径的 URI 规则，使用 WAF 拦截 URI 以 /wp-admin 开头的所有请求。

 - Rule type：保留缺省的“Rule builder”选项
 - Name: url-rule
 - Type: Regular rule
 - If a request: matches the statement
 - Inspect: URL Path
 - Match Type: Starts with string
 - String to Match: /wp-admin
 - Action: Block

点击【Add rule】按钮。

![](/images/3.NetworkSecurity/WAF-CF-5.png)

2.再次在“Add rules”下拉菜单选择“Add my own rules and rule groups”选项。
定义基于 HTTP 请求速率的规则，常用于 DDoS 攻击防护。

 - Name: rate-rule
 - Type: Rate-based rule
 - Rate limit: 100  
 ##单个 IP 在5分钟内的 HTTP 请求超过100，则 WAF 会 Block 该 IP 地址
 - IP address to use for rate limiting: Source IP address   
 ##根据 HTTP 的源 IP 计算请求速率，也支持根据 header 中的 IP 地址计算请求速率
 - Criteria to count request towards rate limit: Consider all requests   
 ##根据所有 request 计算请求速率，也支持根据某些 HTTP 特征（header/path/query等）来计算请求速率
 - Action: Block

 ![](/images/3.NetworkSecurity/WAF-CF-6.png)

##### 3. 调整 WAF 规则优先级
调整 WAF 规则的优先级，通过点击【Move up】按钮，将自定义的 Block 规则调整到最优先。点击【Next】按钮，并在“Review and create web ACL”页面上点击【Create web ACL】按钮。

 ![](/images/3.NetworkSecurity/WAF-CF-7.png)

##### 4. 配置 CloudWatch Metrics
为每个规则使用默认的 CloudWatch Metrics Name，并启用 Sampled request

 ![](/images/3.NetworkSecurity/WAF-CF-8.png)

#### 第三步，将 WAF Web ACL 关联到 CloudFront Distribution 资源

在WAF控制台上，点击Web ACL，点击我们在上一步中创建的“WAF-CloudFront” ACL。
在“Associated AWS resources”页面上，选择【Add AWS resources】按钮，选中名称中带有“Cloudfront-for-WP”的CloudFront Distribution，并点击【Add】按钮。

 ![](/images/3.NetworkSecurity/WAF-CF-9-1.png)
 ![](/images/3.NetworkSecurity/WAF-CF-9.png)

{{% notice note %}}
一个 WAF WebACL 可以关联多个 CloudFront Distribution，一个 CloudFront Distribution 只能关联一个 WAF Web ACL。
{{% /notice  %}}

## 验证 WAF 规则


#### 验证基于 HTTP 请求特征的自定义 WAF 规则
访问之前应用系统的管理界面：http://\<WordpressApplicationURL>/wp-admin/

URI 为 /wp-admin, 可以看到该 HTTP 请求被 WAF 拦截。

![](/images/3.NetworkSecurity/WAF-CF-10.png)

然后回到WAF控制台，进入“Web ACL”，并进入“WAF-CloudFront”，然后选中“url-rule”，点击【Delete】按钮。
![](/images/3.NetworkSecurity/WAF-CF-10-1.png)

在弹出界面上，输入“delete”，点击【Delete】按钮，将其删除。
![](/images/3.NetworkSecurity/WAF-CF-10-2.png)


#### 验证基于 HTTP 请求速率的自定义 WAF 规则

在 AWS 控制台中，打开 Cloud9 IDE。

安装 ApacheBench ab 工具对 CloudFront Distribution 进行压力测试，触发 WAF rate-based rule。

首先安装 ApacheBench，查看 cloud9 IDE 的 Public IP。
```
sudo yum install httpd-tools -y
curl ifconfig.me
```
假设输出的Public IP为：54.158.164.3

使用 ab 工具，请求 CloudFront Distribution 域名，注意把下面的“d2avv37lq284rd.cloudfront.net”部分替换为你的CloudFront Distribution的实际域名。
```
ab -c 10 -n 1000 http://d2avv37lq284rd.cloudfront.net/wp-admin/
```

再次请求 CloudFront 域名，提示 Request blocked，即请求已被 WAF 拦截
```
curl http://d2avv37lq284rd.cloudfront.net/wp-admin/
```
其输出类似如下：
```
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Request blocked.
```

在 Cloud9 IDE 中， 通过 AWS CLI 查看被 WAF rate-based rule 所拦截的 IP。

首先使用下面的命令，查看当前 Web ACL 的 Name 和 ID。
```
aws wafv2 list-web-acls --scope CLOUDFRONT --region=us-east-1
```
其输出类似如下：
```
{
    "NextMarker": "WAF-CloudFront",
    "WebACLs": [
        {
            "Name": "WAF-CloudFront",
            "Id": "a9d01e49-e57b-4561-8cb2-3f0caf857608",
            "Description": "",
            "LockToken": "c421b1cd-41e3-409f-9f3e-5a0a6855a76a",
            "ARN": "arn:aws:wafv2:us-east-1:699962710372:global/webacl/WAF-CloudFront/a9d01e49-e57b-4561-8cb2-3f0caf857608"
        }
    ]
}
```
然后执行下面的命令，查看当前被 WAF rate-based rule 所拦截的 IP。其中：

 - web-acl-name: 上一步 CLI Response 中的 Name 字段
 - web-acl-id: 上一步 CLI Response 中的 Id 字段
 - rule-name: rate-rule

```
aws wafv2 get-rate-based-statement-managed-keys --scope=CLOUDFRONT --region=us-east-1 --web-acl-name=WAF-CloudFront --web-acl-id=a9d01e49-e57b-4561-8cb2-3f0caf857608 --rule-name=rate-rule
```
其输出类似如下：
```
{
    "ManagedKeysIPV4": {
        "IPAddressVersion": "IPV4",
        "Addresses": [
            "54.158.164.3/32"
        ]
    },
    "ManagedKeysIPV6": {
        "IPAddressVersion": "IPV6",
        "Addresses": []
    } 
}
``` 

如果该 IP 在5分钟窗口内的请求总数下降到 rate-based rule 所定义的 threshold 以下，则 AWS WAF 会从 Blocked IP list 中释放该 IP。

## 查看 WAF Sampled Request

在 AWS WAF 控制台中，可以查看 Web ACL 对应 HTTP 请求的采样记录（不是请求日志），包括请求的Source IP，URI，Action，以及匹配的 WAF 规则。

 ![](/images/3.NetworkSecurity/WAF-CF-11.png)

---
title: "开启VPC Flow Log并传入CloudWatch Logs日志组"
chapter: false
weight: 32
tags:
  - beginner
---

## 开启VPC Flow Log(流日志)，存储并查询

利用 VPC 流日志这项功能，您可以捕获有关传入和传出您的 VPC 中网络接口的 IP 流量的信息，并将日志数据发布到 Amazon CloudWatch Logs 或 Amazon S3。您可以采用多种方法在选定目标中检索和查看其数据。

VPC Flow Log可帮助您实现多种任务，例如：

- 监控到达您实例的流量
- 确定在网络接口上往返的流量的方向
- 诊断过于严格的安全组规则

Flow Log包含的内容示例：

![](/images/3.NetworkSecurity/3.2.1.png)

有关日志字段详细说明请参考在线文档： https://docs.aws.amazon.com/zh_cn/vpc/latest/userguide/flow-logs.html#flow-logs-default

要创建流日志，需要指定：

- 要为其创建流日志的资源
- 要捕获的流量的类型（接受的流量、拒绝的流量或所有流量）
- 指定您要将流日志数据发布到的目标

### 创建CloudWatch Logs日志组

1. 进入CloudWatch日志组控制台并切换为中文界面，点击【创建日志组】按钮：
https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups
![](/images/3.NetworkSecurity/3.2.3.png)
2. 在页面中填写日志组名称：“Secworkshopvpc_flowlog”。在“保留设置”下拉框里，选择“1周(7天)”，点击【创建】按钮。
![](/images/3.NetworkSecurity/3.2.4.png)

### 创建流日志：

1. 打开VPC控制台，选择在上一步创建的VPC(SecWorkshopVPC)，在流日志中点击【创建流日志】按钮。
https://ap-northeast-1.console.aws.amazon.com/vpc/home?region=ap-northeast-1#vpcs:search=SecWorkshopVPC
![](/images/3.NetworkSecurity/3.2.2.png)
2. 在页面中：
- 在“名称”一栏输入名称，比如：Secworkshopvpc_flow。
- 在“筛选条件”中选择“**全部**”单选框。
- 在“最大聚合时间间隔”选择“10分钟”
- 在“目标”中选择“发送到CloudWatch Logs”
- 在“目标日志组”下拉列表中选择上一步骤中创建的日志组：“Secworkshopvpc_flowlog”。
- 在“IAM角色”中，点击“设置权限”链接，这会打开一个新的页面，在打开的页面中记录“角色名称”一栏的内容，缺省为“flowlogsRole”，并点击【允许】按钮。
- 切换回至创建流日志页面中，在IAM 角色下拉列表中选择刚刚记录的角色名称：“flowlogsRole”。
![](/images/3.NetworkSecurity/3.2.10.png)
其他选择可保持默认，点击【创建流日志】按钮完成创建。
3. 如果要浏览查询VPC流日志，转至CloudWatch Logs控制台，并过滤出之前创建的、名为Secworkshopvpc_flowlog的日志组：
https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups$3FlogGroupNameFilter$3DSecworkshopvpc_flowlog 

点击该日志组，即可进入日志流的具体数据界面，其中的事件流按照ENI进行区分，然后点击各个ENI，即可对日志数据进行浏览或搜索。
注意，刚创建完日志流时，这里可能并没有结果，需要等3-5分钟左右，就会看到产生的日志流数据。
![](/images/3.NetworkSecurity/3.2.11.png)


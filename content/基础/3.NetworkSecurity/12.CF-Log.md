---
title: "启用 CloudFront 访问日志并使用 Athena 查询"
chapter: false
weight: 36
tags:
  - beginner
---

## 启用CloudFront访问日志并使用Athena查询

Amazon CloudFront 提供两种不同类型的日志记录，记录到达 CloudFront distribution 的请求。

**[标准日志（访问日志）](https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html)**
 - CloudFront 标准日志提供有关向distribution发出的每个请求的详细记录，常用于安全和访问审计。
 - CloudFront 标准日志将传送到您选择的 Amazon S3 存储桶。针对标准日志，CloudFront 不收取费用，但存储和访问日志文件将产生Amazon S3 费用。

**[实时日志](https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/real-time-logs.html)**
 - CloudFront 实时日志可以实时提供有关向分配发出的请求的信息（日志记录在收到请求后的几秒钟内传输）。您可以选择实时日志的采样率即希望接收实时日志记录的请求的百分比。您还可以选择希望在日志记录中接收的特定字段。
 - CloudFront 实时日志将传送到 Amazon Kinesis Data Streams 中您选择的数据流。CloudFront 除了收取因使用 Kinesis Data Streams 产生的费用外，还针对实时日志进行收费。

**本章节将介绍如何在 CloudFront Distribution 中启用标准访问日志，存储到S3，并使用 Athena 对S3中的CloudFront日志进行查询分析。**

### 为 CloudFront Distribution 启用标准访问日志

CloudFront日志默认是disabled，用户需要基于每个 Distribution 启用。

进入CloudFront控制台：
https://console.aws.amazon.com/cloudfront/home?region=ap-northeast-1#

在 CloudFront 控制台上：

- 找到“注释”名为：Cloudfront-for-WP 的distribution
- 进入需要启用日志的 Distribution
- 在“常规”页面，点击【编辑】按钮。
- 找到“标准日志记录”单选框，选择“打开”，启用 Logging 相关配置。
- 在“日志的 S3 存储桶”下拉框，选择前面你所创建的名为<你的姓名拼音首字母>-secworkshop的存储桶。
- 日志前缀，可以为 CloudFront 日志存在S3 Bucket 中指定一个前缀。这里指定为“cflogs”。
- Cookie日志记录保留缺省的“关闭”。

![](/images/3.NetworkSecurity/EnableCloudFrontLogging.png)

{{% notice note %}}
当您创建或更新 Distribution 并启用日志时，CloudFront 会自动更新存储桶的 ACL，以授予 awslogsdelivery 账户 FULL_CONTROL 权限。awslogsdelivery 账户将日志文件写入存储桶。如果您的 IAM 账户没有更新 ACL 所需的权限，则创建或更新 Distribution 将会失败。如果修改或删除对 awslogsdelivery 账户的权限，则 CloudFront 无法将日志保存到 S3 存储桶
{{% /notice  %}}
```
{
    "Sid": "AWSLogDeliveryWrite",
    "Effect": "Allow",
    "Principal": {
        "Service": "delivery.logamazonaws.com"
    },
    "Action": "s3:PutObject",
    "Resource": "arn:aws:s3:::xxxxxxxxx/*",
    "Condition": {
        "StringEquals": {
            "s3:x-amz-acl""bucket-owner-full-control"
        }
    }
},
```

CloudFront 日志保存到S3中，通常会有10分钟-1小时的延迟，日志对象的名称会包括 DistributionID，保存时间（UTC），并以gz格式压缩。
![](/images/3.NetworkSecurity/CloudFrontLogs-in-S3.png)

### 使用 Athena 分析 CloudFront 访问日志

[在此可以查看 CloudFront 访问日志的格式，目前支持33个字段。](https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html#LogFileFormat)

1. 进入Athena控制台：
https://ap-northeast-1.console.aws.amazon.com/athena/home?region=ap-northeast-1#query

使用 Athena 分析 CloudFront日志时，首先在 Athena Query editor 中使用以下 DDL 语句，点击【Run query】按钮，或‘ctrl+Enter'创建表。 
**请注意修改用于存储日志的 Amazon S3 存储桶的 LOCATION。**
以下语句将创建一个名称为‘cloudfront_logs'的表：	
```
CREATE EXTERNAL TABLE IF NOT EXISTS default.cloudfront_logs (
  `date` DATE,
  time STRING,
  location STRING,
  bytes BIGINT,
  request_ip STRING,
  method STRING,
  host STRING,
  uri STRING,
  status INT,
  referrer STRING,
  user_agent STRING,
  query_string STRING,
  cookie STRING,
  result_type STRING,
  request_id STRING,
  host_header STRING,
  request_protocol STRING,
  request_bytes BIGINT,
  time_taken FLOAT,
  xforwarded_for STRING,
  ssl_protocol STRING,
  ssl_cipher STRING,
  response_result_type STRING,
  http_version STRING,
  fle_status STRING,
  fle_encrypted_fields INT,
  c_port INT,
  time_to_first_byte FLOAT,
  x_edge_detailed_result_type STRING,
  sc_content_type STRING,
  sc_content_len BIGINT,
  sc_range_start BIGINT,
  sc_range_end BIGINT
)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY '\t'
LOCATION 's3://<CloudFront_bucket_name>/cflogs/'
TBLPROPERTIES ( 'skip.header.line.count'='2' )

```
![](/images/3.NetworkSecurity/AthenaCreateTable-CloudFrontLogs.png)
2. 运行成功后，在 Athena Console 的左侧会出现新创建的 ’cloudfront_logs' 表，可以‘Preview Table’运行一次查询。
![](/images/3.NetworkSecurity/AthenaPreviewTable-CloudFrontLogs.png)
3. 自定义 SQL DML 语句，分析 CloudFront 日志。
例如查看一段时间内，每天的5xx错误数量，以及出现5xx错误的用户请求URI
	
```
SELECT date, COUNT(*) as error5xx, uri
FROM "default"."cloudfront_logs"
WHERE "status"
    BETWEEN 500
        AND 599
        AND "date"
    BETWEEN DATE '2020-12-01'
        AND DATE '2020-12-29'
GROUP BY "date" , "uri"
ORDER BY "date"
;
```
![](/images/3.NetworkSecurity/AthenaQuerySample-CloudFrontLogs.png)
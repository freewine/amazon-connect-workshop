---
title: "将VPC Flow Log导入至S3并使用Athena进行分析"
chapter: false
weight: 34
tags:
  - beginner
---

## 将VPC Flow Log导入至S3并使用Athena进行分析

如果不需要实时监控流日志，则也可以选择把流日志保存到S3上，同时费用相比CloudWatch也会更便宜，同时也能永久保留日志。

### 创建S3存储桶，用于存储流日志内容

1. 打开S3控制台，从而创建S3存储桶：
https://s3.console.aws.amazon.com/s3/home?region=ap-northeast-1#

点击【创建存储桶】按钮。在“存储同名称”一栏输入存储桶名称，比如<你的姓名拼音首字母>-vpcflowlog-secworkshop。其他选项保留缺省值，点击【创建存储桶】按钮完成创建。
![](/images/3.NetworkSecurity/3.4.1.png)
然后进入该存储桶的“属性”页面，拷贝该存储桶的Amazon 资源名称(ARN)：
https://s3.console.aws.amazon.com/s3/buckets/hsj-vpcflowlog-secworkshop?region=ap-northeast-1&tab=properties

2. 按照前面启用VPC Flow Log的方法，打开VPC控制台，选择在上一步创建的VPC(SecWorkshopVPC)，在流日志中点击【创建流日志】按钮。
https://ap-northeast-1.console.aws.amazon.com/vpc/home?region=ap-northeast-1#vpcs:search=SecWorkshopVPC

3. 在页面中：
- 在“名称”一栏输入名称，比如：Secworkshopvpc_flow2S3。
- 在“筛选条件”中选择“**全部**”单选框。
- 在“最大聚合时间间隔”选择“10分钟”
- 在“目标”中选择“发送到 Amazon S3 存储桶”
- 在“S3 存储桶 ARN”文本框里输入第一步中所拷贝的存储桶的ARN：arn:aws:s3:::<你的姓名拼音首字母>-vpcflowlog-secworkshop。
点击【创建日志流】按钮。

### 使用Athena进行查询分析

1. 进入Athena控制台：
https://ap-northeast-1.console.aws.amazon.com/athena/home?region=ap-northeast-1

将以下DDL语句粘贴到查询编辑器中。

{{% notice note %}}
注意：在下面的命令中，替换存储桶名称，以及实际的AWS账号
{{% /notice  %}}

   ```sql 
   CREATE EXTERNAL TABLE IF NOT EXISTS vpc_flow_logs (
     version int,
     account string,
     interfaceid string,
     sourceaddress string,
     destinationaddress string,
     sourceport int,
     destinationport int,
     protocol int,
     numpackets int,
     numbytes bigint,
     starttime int,
     endtime int,
     action string,
     logstatus string
   )  
   PARTITIONED BY (dt string)
   ROW FORMAT DELIMITED
   FIELDS TERMINATED BY ' '
   LOCATION 's3://<你的姓名拼音首字母>-vpcflowlog-secworkshop/AWSLogs/<你的AWS账号>/vpcflowlogs/ap-northeast-1/'
   ```
   添加当天对应的分区，比如当天为1月31日，则按照如下方式添加分区：
   ```
   ALTER TABLE vpc_flow_logs
   ADD PARTITION (`dt`='2021-01-31')
   location 's3://<你的姓名拼音首字母>-vpcflowlog-secworkshop/AWSLogs/<你的AWS账号>/vpcflowlogs/ap-northeast-1/2021/01/31';
   ```   
2.运行查询

   统计前20名被拒绝的地址和流量

   ```sql
   SELECT SUM(numpackets) AS
     packetcount,
     sourceaddress,
     destinationaddress
   FROM vpc_flow_logs
   WHERE action = 'REJECT' 
   GROUP BY 
     sourceaddress, 
     destinationaddress
   ORDER BY packetcount DESC
   LIMIT 20;
   ```

   ![](/images/3.NetworkSecurity/3.4.5.png)

   查询100个被拒绝流量的详细情况

   ```sql
   SELECT *
   FROM vpc_flow_logs
   WHERE action = 'REJECT' 
   LIMIT 100;
   ```

   ![](/images/3.NetworkSecurity/3.4.6.png)
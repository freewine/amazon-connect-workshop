---
title: "使用Session Manager作为堡垒机方案"
chapter: false
weight: 52
tags:
  - beginner
---


### session manager 介绍
Session Manager是一个完全托管的AWS Systems Manager功能，可让您管理EC2实例、本地实例，和虚拟机 （VM），通过基于浏览器的交互式一键式shell或通过 AWS Command Line Interface （AWS CLI）。 Session Manager提供安全且可审核的实例管理，无需打开入站端口。维护堡垒主机，或管理SSH密钥。Session Manager还使您能够轻松遵守需要对实例进行受控访问的公司策略。严格的安全实践，和具有实例访问详细信息的完全可审计日志 同时，仍为最终用户提供对托管实例的简单一键式跨平台访问。

### 实验介绍
在本次实验中，我们会使用前一次实验步骤中启动的、运行了应用程序的EC2实例，通过session manager对这些服务器进行管理。
这些实例处于私有子网中，并不能通过公网访问，而通过session manager可以方便的运维。

### 实验步骤

1. 找到在[部署动手实验示例应用程序]({{< ref "基础/3.networksecurity/11.deployapps.md" >}})部分中部署的两台应用服务器：
https://ap-northeast-1.console.aws.amazon.com/ec2/v2/home?region=ap-northeast-1#Instances:instanceState=running;search=WordpressServer
注意该实例是部署在私有网络里的，没有公网ip地址。然后拷贝这两个实例的实例id。
2. 登录到Cloud9 IDE控制台。
下面创建session manager所需要用到的权限策略和角色。

编辑policy文件，取名为：ssm.policy，然后把下面的内容拷贝到该文件里：
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssmmessages:*",
                "ssm:*",
                "ec2messages:*"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject"
            ],
            "Resource": "arn:aws:s3:::<你的姓名拼音首字母>-secworkshop/ssmlog"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetEncryptionConfiguration"
            ],
            "Resource": "*"
        }
    ]
}
```

执行下面的命令，创建名为ssm-policy的策略，把下面的输出内容里的"Arn"的值记录下来，该值会用于把策略与角色关联的时候使用。
```
aws iam create-policy --policy-name ssm-policy --policy-document file://ssm.policy
```
其输出类似如下内容：
```
{
    "Policy": {
        "PolicyName": "ssm-policy",
        "PolicyId": "ANPA2KZ52OC3RR3XUHRUO",
        "Arn": "arn:aws:iam::123456789012:policy/ssm-policy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 0,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "CreateDate": "2021-01-16T11:15:30+00:00",
        "UpdateDate": "2021-01-16T11:15:30+00:00"
    }
}
```

编辑信任关系文件，取名为：assumerole.json，并把下面的内容拷贝进该文件:
```
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal": {"Service":["ec2.amazonaws.com","ssm.amazonaws.com"]},
    "Action": "sts:AssumeRole"
  }
}
```

执行下面的命令，创建名为SSM-Role的角色：
```
aws iam create-role --role-name SSM-Role --assume-role-policy-document file://assumerole.json
```

执行下面的命令，把前面创建的策略赋予SSM-Role。
```
aws iam attach-role-policy --role-name SSM-Role --policy-arn <你所创建的ssm-policy的ARN>
```
3. 依次执行下面的命令，把SSM-Role角色与第一步中所记录的应用服务器实例关联。
```
aws iam create-instance-profile --instance-profile-name SSM-Role-Instance-Profile
aws iam add-role-to-instance-profile --role-name SSM-Role --instance-profile-name SSM-Role-Instance-Profile
aws ec2 associate-iam-instance-profile --instance-id <第一步中所记录的实例1的ID> --iam-instance-profile Name=SSM-Role-Instance-Profile
aws ec2 associate-iam-instance-profile --instance-id <第一步中所记录的实例2的ID> --iam-instance-profile Name=SSM-Role-Instance-Profile
```
4. 进入session manager的控制台的管理配置界面：
https://ap-northeast-1.console.aws.amazon.com/systems-manager/session-manager/preferences?region=ap-northeast-1

    - 在“首选项”页面上，点击【编辑】按钮。 
    - 在“S3 logging”部分，从下拉列表里选择“<你的姓名拼音首字母>-secworkshop”的存储桶，并在“S3 密钥前缀”部分输入“session-manager”。
    - 点击【保存】按钮。

![](/images/5.SecOps/ssm_logging_to_s3.png)
5. 进入session manager的控制台界面：
https://ap-northeast-1.console.aws.amazon.com/systems-manager/session-manager/start-session?region=ap-northeast-1
选中实例名称为“WordpressServer1”的实例，点击【启动会话】按钮。

6. 登录到该应用服务器以后，检查当前Apache web服务器的运行状态。
```
sudo su - ec2-user
sudo systemctl status httpd
```
![](/images/5.SecOps/ssm_connect_to_ec2_operation.png)

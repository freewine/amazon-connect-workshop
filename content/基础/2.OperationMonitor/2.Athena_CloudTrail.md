---
title: "Athena查询CloudTrail"
chapter: false
weight: 22
tags:
  - beginner
---
## 使用 CloudTrail 控制台为 CloudTrail 跟踪创建 Athena 表
1. 打开 CloudTrail 控制台，并进入“事件历史记录”界面：
https://ap-northeast-1.console.aws.amazon.com/cloudtrail/home?region=ap-northeast-1#/events?ReadOnly=false
2. 选择【创建Athena表】按钮. 
![](/images/2.OperationMonitor/cloudtrailmonitor.png)
3. 对于存储位置，使用向下箭头选择其中存储了供跟踪查询的日志文件的 Amazon S3 存储桶。
![](/images/2.OperationMonitor/createathentab.png) 
4. 选择【创建表】按钮。将使用包含 Amazon S3 存储桶名称的默认名称创建表。 
## CloudTrail 日志的示例查询
1. 打开Athena 控制台：
https://ap-northeast-1.console.aws.amazon.com/athena/home?region=ap-northeast-1#query
2. 在左侧确认Data source为**AwsDataCatalog**, Database 为default, 此时cloudtrail log table会列在**Tables**下.
如果看到下面的提示，则需要先设置Athena的输出结果所在的存储桶，选择前面创建的<你的姓名拼音首字母>-secworkshop即可。
![](/images/2.OperationMonitor/athena1.png) 
3. 在右侧query窗口中粘贴下列语句并执行，查询IAMUser界面登录记录
    ```sql
    SELECT *    
    FROM "default"."<cloudtrail table name>"
    WHERE 
        eventname in ('ConsoleLogin') and useridentity.type='IAMUser' 
    LIMIT 10
    ```
---
title: "启用CloudTrail"
chapter: false
weight: 21
tags:
  - beginner
---
## CloudTrail 介绍
AWS CloudTrail 是一项 AWS 服务，可帮助对您的 AWS 账户进行监管、合规性检查、操作审核和风险审核。
用户、角色或 AWS 服务执行的操作将记录为 CloudTrail 中的事件。
事件包括在 AWS 管理控制台、AWS Command Line Interface 和 AWS SDKs 和 APIs 中执行的操作。 
详情请见官方文档：https://docs.aws.amazon.com/zh_cn/awscloudtrail/latest/userguide/cloudtrail-user-guide.html

### 在命令行中启用CloudTrail
#### 在创建CloudTrail日志追踪之前，先创建一个s3桶，用于存储CloudTrail日志:
1. 登录AWS Cloud9 IDE，并运行下列命令创建一个存放CloudTrail日志的s3存储桶：
```shell
   aws s3 mb s3://<你的姓名的拼音首字母>-secworkshop --region ap-northeast-1
```
执行下面的命令获得当前的AWS账号的id，并记住该id
```shell
   aws sts get-caller-identity --query 'Account' --output text
```
2. 编辑CloudTrail所需要的策略文件:
```shell
vi cloudtrail.policy
```
把下面的内容拷贝进去，注意把下面内容中的<你的姓名的拼音首字母>-secworkshop和<你的AWS账号的ID>替换为实际的内容
```shell
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AWSCloudTrailAclCheck20150319",
            "Effect": "Allow",
            "Principal": {"Service": "cloudtrail.amazonaws.com"},
            "Action": "s3:GetBucketAcl",
            "Resource": "arn:aws:s3:::<你的姓名的拼音首字母>-secworkshop"
        },
        {
            "Sid": "AWSCloudTrailWrite20150319",
            "Effect": "Allow",
            "Principal": {"Service": "cloudtrail.amazonaws.com"},
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::<你的姓名的拼音首字母>-secworkshop/AWSLogs/<你的AWS账号的ID>/*",
            "Condition": {"StringEquals": {"s3:x-amz-acl": "bucket-owner-full-control"}}
        }
    ]
}
```
3. 执行下面的命令把policy设置到s3 bucket上：
```shell
aws s3api put-bucket-policy --bucket <你的姓名的拼音首字母>-secworkshop --policy file://cloudtrail.policy
```

#### 在命令行中输入下列命令，创建一个CloudTrail 日志：<BR>
其中trail的名称可以为<你的姓名的拼音首字母>-trail
```shell
aws cloudtrail create-trail --name <你的姓名的拼音首字母>-trail --s3-bucket-name <你的姓名的拼音首字母>-secworkshop --is-multi-region-trail --enable-log-file-validation
```
然后启动你所创建的CloudTrail日志：
```shell
aws cloudtrail start-logging --name <你的姓名的拼音首字母>-trail
```


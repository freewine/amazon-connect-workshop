---
title: "GuardDuty启用及监控"
chapter: false
weight: 24
tags:
  - beginner
---

## Amazon GuardDuty 是什么
Amazon GuardDuty 是一项连续安全监控服务,可以分析和处理以下 数据源: VPC 流日志、AWS CloudTrail 管理事件日志、Cloudtrail S3 数据事件日志和 DNS 日志。它使用威胁情报源（例如，恶意 IP 地址和域的列表）和机器学习来标识您 AWS 环境中意外的和未经授权的恶意活动。这可能包括特权升级、使用公开的凭证、与恶意 IP 地址或域通信等问题。例如，GuardDuty 可检测提供恶意软件或进行比特币挖矿的受损 EC2 实例。此外，它还监控 AWS 账户访问行为是否有受损迹象，如未经授权的基础设施部署（例如，在从未使用过的区域中部署的实例）或异常的 API 调用（例如，更改密码策略以减小密码强度）。

<BR>

### 设置 GuardDuty
1. 任何具有管理员访问权限的用户都可以启用 GuardDuty，但是，根据最小权限的安全最佳做法，建议您创建 IAM 用户、角色或组以专门管理 GuardDuty。
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "guardduty:*"
                ],
                "Resource": "*"
            },
            {
                "Effect": "Allow",
                "Action": [
                    "iam:CreateServiceLinkedRole"
                ],
                "Resource": "arn:aws:iam::<你的AWS账号>:role/aws-service-role/guardduty.amazonaws.com/AWSServiceRoleForAmazonGuardDuty",
                "Condition": {
                    "StringLike": {
                        "iam:AWSServiceName": "guardduty.amazonaws.com"
                    }
                }
            }

        ]
    } 
    ```
2. 使用步骤 1 中的 IAM 用户的凭证从 https://console.aws.amazon.com/guardduty/ 登录到 GuardDuty 控制台。
3. 首次打开 GuardDuty 控制台时，选择 Get Started (开始使用)，然后选择 Enable GuardDuty (启用 GuardDuty)。

### 设置GuardDuty告警邮件发送的 SNS 主题
1. 登录 Amazon SNS 控制台：https://console.aws.amazon.com/sns/v3/home 。
2. 从左侧导航窗格中选择“主题”菜单选项，然后选择【创建主题】按钮。
3. 在“创建主题”部分中,选择“标准”。接下来,输入主题名称,例如 GuardDuty_to_Email。 其他详细信息是可选的。
4. 选择【创建主题】按钮。此时系统会打开新主题的主题详细信息。
5. 在“订阅”部分中，选择“创建订阅”。
   - 从“协议”菜单中，选择“电子邮件”。
   - 在“终端节点”字段中，添加您想要用于接收通知的电子邮件地址。创建后，您需要通过电子邮件客户端确认订阅。
   - 选择【创建订阅】按钮。
6. 在收件箱中查收订阅消息，然后选择 Confirm Subscription (确认订阅)

### 为GuardDuty 启用Cloudwatch 监控
1. 通过以下网址打开 CloudWatch 控制台： https://console.aws.amazon.com/cloudwatch/
2. 从左侧导航窗格中选择 “规则”，然后在右侧窗口中选择【创建规则】按钮。
3. 从“服务名称”下拉菜单中,选择 GuardDuty。
4. 从“事件类型”下拉菜单中,选择 GuardDuty Finding。
5. 在“事件模式预览”中，选择【编辑】按钮。
6. 将下面的 JSON 代码粘贴到“事件模式预览”文本框中，然后选择【保存】按钮。这会对Medium到High级别的事件进行告警。
    ```json
    {
        "source": [
            "aws.guardduty"
        ],
        "detail-type": [
            "GuardDuty Finding"
        ],
        "detail": {
            "severity": [
            4,
            4.0,
            4.1,
            4.2,
            4.3,
            4.4,
            4.5,
            4.6,
            4.7,
            4.8,
            4.9,
            5,
            5.0,
            5.1,
            5.2,
            5.3,
            5.4,
            5.5,
            5.6,
            5.7,
            5.8,
            5.9,
            6,
            6.0,
            6.1,
            6.2,
            6.3,
            6.4,
            6.5,
            6.6,
            6.7,
            6.8,
            6.9,
            7,
            7.0,
            7.1,
            7.2,
            7.3,
            7.4,
            7.5,
            7.6,
            7.7,
            7.8,
            7.9,
            8,
            8.0,
            8.1,
            8.2,
            8.3,
            8.4,
            8.5,
            8.6,
            8.7,
            8.8,
            8.9
            ]
        }
    }
    ```
7. 在“目标”部分，点击【添加目标】按钮。
8. 从 Select Targets (选择目标) 下拉菜单中，选择“SNS 主题”。
9. 在“主题”下拉菜单中，请选择上一步创建的 SNS 主题，比如这里是GuardDuty_to_Email。
10. 为事件配置输入。
    - 展开“配置输入”，然后选择“输入转换器”单选框。
    - 复制以下代码并将其粘贴到“输入路径”字段中。
    ```json
    {
        "severity": "$.detail.severity",
        "Finding_ID": "$.detail.id",
        "Finding_Type": "$.detail.type",
        "region": "$.region",
        "Finding_description": "$.detail.description"
    }
    ```
    - 复制以下代码并将其粘贴到“输入模板”字段中，以便格式化电子邮件。
    ```
    "You have a severity <severity> GuardDuty finding type <Finding_Type> in the <region> region."
    "Finding Description:"
    "<Finding_description>. "
    "For more details open the GuardDuty console at https://console.aws.amazon.com/guardduty/home?region=<region>#/findings?search=id%3D<Finding_ID>"            
    ```
	![](/images/2.OperationMonitor/guardduty_alarm1.png)
11. 选择【配置详细信息】按钮。 
12. 在“配置规则详细信息”页面中，输入规则的“名称”，比如“guardduty_alarm”，以及“描述”，比如“alarm for guardduty”，然后选择【创建规则】按钮。“状态”复选框选择“已启用”。
13. 点击【创建规则】按钮。
![](/images/2.OperationMonitor/guardduty_alarm2.png)

---
title: "CloudTrail事件监控及通知"
chapter: false
weight: 23
tags:
  - beginner
---
## 使用 CloudTrail和CloudWatch 监控登录失败事件 
1. 打开 CloudTrail 控制台: https://console.aws.amazon.com/cloudtrail/
2. 点击记录日志的trail名字：<你的姓名拼音首字母>-trail，进入trail 设置
3. 当前页面向下滚动，找到并点击 CloudWatch Logs 的 【编辑】 按钮，进入编辑页面 <br>
![](/images/2.OperationMonitor/cloudtrail_cwl.jpg)
4. 勾选 CloudWatch Logs下的 “已启用”复选框
- 选中日志组, 在日志组名称中输入Cloudtrail 的log 名称，比如为：aws-cloudtrail-logs-tokyo
- 在 IAM 角色中选择 New 并输入role的名称，比如为：aws-cloudtrail-logs-tokyo-role
- 点击【保存更改】按钮 <br>
![](/images/2.OperationMonitor/cloudtrail_cwl_detail.jpg)
5. 进入 CloudWatch 控制台中的日志组界面： https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups 
6. 在日志组的过滤窗口中，输入为 CloudTrail 日志事件创建的日志组的名称：“aws-cloudtrail-logs-tokyo”。
然后勾选其旁边的复选框，并点击【操作】下拉菜单。
![](/images/2.OperationMonitor/cloudwatch_log_group1.png)
7. 选择 【创建指标筛选条件】选项。 
8. 在“筛选模式”一栏，键入以下内容：
```
{ ($.eventName = ConsoleLogin) && ($.errorMessage = "Failed authentication") }
```
![](/images/2.OperationMonitor/cloudwatch_log_group2.png)
9. 点击【Next】按钮，在“分配指标”界面上，
- 在“筛选名称”一栏，键入 ConsoleSignInFailures 
- 在“指标命名空间”一栏，键入 CloudTrailMetrics 
- 在“指标名称”一栏，键入 ConsoleSigninFailureCount 
- 在“指标值”一栏，键入 1
10. 点击【Next】按钮，进入“Review and create”界面。
![](/images/2.OperationMonitor/cloudwatch_log_group3.png)
11. 点击【创建指标筛选条件】按钮。

## 设置CloudTrail告警邮件发送的 SNS 主题
1. 登录 Amazon SNS 控制台： https://console.aws.amazon.com/sns/v3/home
2. 从左侧导航窗格中选择“主题”菜单选项，然后选择【创建主题】按钮。
3. 在“创建主题”部分中,选择“标准”。接下来,输入主题名称,例如“CloudTrail_to_Email"。配置保留缺省值。
4. 选择【创建主题】按钮。此时系统会打开新主题的主题详细信息。
5. 在“订阅”部分中，选择“创建订阅”。
   - 从“协议”菜单中，选择“电子邮件”。
   - 在“终端节点”字段中，添加您想要用于接收通知的电子邮件地址。创建后，您需要通过电子邮件客户端确认订阅。
   - 选择【创建订阅】按钮。
6. 在收件箱中查收订阅消息，然后点击邮件内容中的“Confirm Subscription”链接进行确认。

## 通过AWS SNS关联email报警
1. 在 Metric Filters 页面选中刚刚创建的filter(右上角小勾),在筛选条件名称旁边,选择【创建警报】按钮。
![](/images/2.OperationMonitor/cloudtrail_cw_alarm_sns1.png)
2. 在“创建警报”页面的第一步：“指定指标和条件”中，“定义阈值”处输入“0”，其他保留缺省值，点击【下一步】按钮。 
3. 在“配置操作”页面中，在“发送邮件通知到...”下拉框中，选择上一步创建的SNS主题“CloudTrail_to_Email”，其他保留缺省值，点击【下一步】按钮。
4. 在“添加名称和描述”页面中，“警报名称”输入“Alarm-SigninFailure”，点击【下一步】按钮。
5. 点击【创建警报】按钮。
6. 尝试几次登录失败。接受失败登录邮件。

{{% notice info %}}
注意，告警通知的邮件可能会有数分钟的延迟，可以先做后面的实验。
{{% /notice  %}}
